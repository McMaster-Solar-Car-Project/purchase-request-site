<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Request Dashboard</title>
    <link rel="stylesheet" href="/static/css/output.css">
</head>

<body class="font-sans m-0 py-10 px-5 bg-gray-100 leading-relaxed min-h-screen">
    <div class="max-w-6xl mx-auto p-5 bg-white rounded-xl shadow-lg">
        <div class="flex justify-between items-center py-4 border-b-2 border-gray-200 mb-8">
            <h1 class="text-gray-800 m-0 text-3xl font-bold">Purchase Request Dashboard</h1>
            <div class="flex items-center gap-4 flex-wrap">
                <a href="/edit-profile?user_email={{ user_email }}" 
                   class="bg-green-600 text-white no-underline py-2 px-4 rounded-md font-bold transition-all duration-300 ease-in-out border-none cursor-pointer hover:bg-green-700 hover:text-white hover:-translate-y-0.5">✏️ Edit Information</a>
                <a href="/logout" 
                   class="bg-red-600 text-white no-underline py-2 px-4 rounded-md transition-all duration-300 ease-in-out hover:bg-red-700 hover:text-white">Logout</a>
            </div>
        </div>

        {% if success_message %}
        <div class="bg-green-100 text-green-800 p-4 rounded-lg mb-5 border border-green-200 font-bold">
            {{ success_message }}
        </div>
        {% endif %}

        {% if error_message %}
        <div class="bg-red-100 border border-red-200 text-red-800 p-4 rounded mb-5">
            {{ error_message }}
        </div>
        {% endif %}

        <p class="text-gray-600 text-xl mb-8 text-center">Fill out up to 10 separate purchase requests and submit them all together</p>

        <div class="mb-8">
            <div class="bg-gray-100 p-5 rounded border-l-4 border-blue-600">
                <p class="my-2 text-gray-700"><strong>Name:</strong> {{ name }}</p>
                <p class="my-2 text-gray-700"><strong>Team:</strong> {{ team }}</p>
                <p class="my-2 text-gray-700"><strong>McMaster Email:</strong> {{ email }}</p>
                <div class="mt-4 pt-4 border-t border-gray-300">
                    <p class="mb-2 font-bold">Digital Signature:</p>
                    <img src="/{{ session_folder }}/{{ signature }}" alt="Digital Signature" class="max-w-48 max-h-24 border border-gray-300 rounded bg-white p-1 object-contain">
                </div>
            </div>
        </div>


        <form method="POST" action="/submit-all-requests" enctype="multipart/form-data"
            onsubmit="return validateSubmission()">
            <!-- Hidden fields for user data -->
            <input type="hidden" name="name" value="{{ name }}">
            <input type="hidden" name="email" value="{{ email }}">
            <input type="hidden" name="e_transfer_email" value="{{ e_transfer_email }}">
            <input type="hidden" name="address" value="{{ address }}">
            <input type="hidden" name="team" value="{{ team }}">
            <input type="hidden" name="session_folder" value="{{ session_folder }}">
            <input type="hidden" name="signature" value="{{ signature }}">

            <div class="bg-gray-50 p-8 rounded-lg mt-8 text-left">
                <h2 class="text-gray-800 mb-4 text-center text-xl font-semibold">Your Purchase Request Forms</h2>
                <p class="text-gray-600 text-center mb-8 italic">Fill out any number of the forms below. Empty forms will be ignored when you
                    submit.</p>

                <div class="mb-8">
                    {% for form_num in range(1, 11) %}
                    <div class="bg-white border border-gray-300 rounded-lg mb-4 overflow-hidden">
                        <div class="bg-blue-600 text-white p-4 cursor-pointer flex justify-between items-center transition-colors duration-300 hover:bg-blue-700" onclick="toggleForm({{ form_num }})">
                            <h3 class="m-0 text-lg font-medium">Invoice #{{ form_num }}</h3>
                            <div class="flex items-center gap-4">
                                <button type="button" class="bg-red-600 text-white border-none rounded py-1.5 px-3 text-xs cursor-pointer transition-colors duration-300 whitespace-nowrap hover:bg-red-700"
                                    onclick="event.stopPropagation(); clearForm({{ form_num }})"
                                    title="Clear this form">Clear</button>
                                <span class="font-bold text-xl">▼</span>
                            </div>
                        </div>
                        <div class="hidden p-5 border-t border-gray-300" id="form-{{ form_num }}">
                            <div class="max-w-full">
                                <div class="mb-5">
                                    <label for="vendor_name_{{ form_num }}" class="block mb-2 font-bold text-gray-800">Vendor/Store Name</label>
                                    <input type="text" id="vendor_name_{{ form_num }}" name="vendor_name_{{ form_num }}"
                                        placeholder="Enter the name of the vendor or store"
                                        class="w-full p-3 border border-gray-300 rounded box-border text-base transition-all duration-300 focus:outline-none focus:border-blue-600">
                                </div>

                                <div class="mb-5">
                                    <label for="currency_{{ form_num }}" class="block mb-2 font-bold text-gray-800">Currency</label>
                                    <select id="currency_{{ form_num }}" name="currency_{{ form_num }}"
                                        onchange="updateCurrencyLabels({{ form_num }})"
                                        class="w-full p-3 border border-gray-300 rounded box-border text-base transition-all duration-300 focus:outline-none focus:border-blue-600">
                                        <option value="CAD">CAD - Canadian Dollar</option>
                                        <option value="USD">USD - US Dollar</option>
                                    </select>
                                    <small class="block text-xs text-gray-600 mt-1 italic">Select the currency used for this purchase</small>
                                </div>

                                <div class="mb-5">
                                    <label for="invoice_file_{{ form_num }}" class="block mb-2 font-bold text-gray-800">Upload Invoice/Receipt</label>
                                    <div class="relative inline-block w-full">
                                        <input type="file" id="invoice_file_{{ form_num }}"
                                            name="invoice_file_{{ form_num }}" accept=".pdf,.jpg,.jpeg,.png,.gif"
                                            onchange="updateFileName(this, 'invoice-filename-{{ form_num }}')"
                                            class="absolute opacity-0 w-0.5 h-0.5 overflow-hidden -z-10">
                                        <span class="inline-block bg-blue-600 text-white py-2.5 px-5 border-none rounded cursor-pointer text-sm transition-colors duration-300 mr-2.5 select-none hover:bg-blue-700"
                                            onclick="document.getElementById('invoice_file_{{ form_num }}').click()">Choose
                                            File</span>
                                        <span class="text-gray-600 italic align-middle" id="invoice-filename-{{ form_num }}">No file
                                            chosen</span>
                                    </div>
                                    <small class="block text-xs text-gray-600 mt-1 italic">Please upload your invoice or receipt (PDF, JPG, PNG, or
                                        GIF format)</small>
                                </div>

                                <div class="mb-5 bg-yellow-50 border border-yellow-200 rounded p-4 proof-of-payment-section proof-of-payment-section-{{ form_num }}"
                                    style="display: none;">
                                    <label for="proof_of_payment_{{ form_num }}" class="text-yellow-800 font-bold">Proof of Payment (Required for USD
                                        purchases)</label>
                                    <div class="relative inline-block w-full">
                                        <input type="file" id="proof_of_payment_{{ form_num }}"
                                            name="proof_of_payment_{{ form_num }}" accept=".pdf,.jpg,.jpeg,.png,.gif"
                                            onchange="updateFileName(this, 'payment-filename-{{ form_num }}')"
                                            class="absolute opacity-0 w-0.5 h-0.5 overflow-hidden -z-10">
                                        <span class="inline-block bg-yellow-800 text-white py-2.5 px-5 border-none rounded cursor-pointer text-sm transition-colors duration-300 mr-2.5 select-none hover:bg-yellow-900"
                                            onclick="document.getElementById('proof_of_payment_{{ form_num }}').click()">Choose
                                            File</span>
                                        <span class="text-gray-600 italic align-middle" id="payment-filename-{{ form_num }}">No file
                                            chosen</span>
                                    </div>
                                    <small class="block text-yellow-800 text-xs italic">Upload a screenshot of your bank transaction or payment
                                        confirmation (PDF, JPG, PNG, or GIF format)</small>
                                </div>

                                <div class="my-8 p-5 bg-white rounded border border-gray-300">
                                    <h4 class="text-gray-800 mb-4 text-lg font-semibold">Item Details</h4>
                                    <small class="block text-xs text-gray-600 mb-4 italic">Add the items you purchased (up to 15 items)</small>

                                    <div id="items-container-{{ form_num }}">
                                        <div class="mb-4 p-4 bg-gray-50 rounded border border-gray-200">
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                                                <div class="flex flex-col">
                                                    <label class="font-bold text-gray-800 mb-2 text-sm">Item Name</label>
                                                    <input type="text" name="item_name_{{ form_num }}_1"
                                                        placeholder="Enter item name"
                                                        class="p-3 border border-gray-300 rounded text-sm focus:outline-none focus:border-blue-600 transition-colors">
                                                </div>
                                                <div class="flex flex-col">
                                                    <label class="font-bold text-gray-800 mb-2 text-sm">Usage/Purpose</label>
                                                    <input type="text" name="item_usage_{{ form_num }}_1"
                                                        placeholder="What is this item for?"
                                                        class="p-3 border border-gray-300 rounded text-sm focus:outline-none focus:border-blue-600 transition-colors">
                                                </div>
                                                <div class="flex flex-col">
                                                    <label class="font-bold text-gray-800 mb-2 text-sm">Quantity</label>
                                                    <input type="number" name="item_quantity_{{ form_num }}_1" min="1"
                                                        value="1" oninput="calculateItemTotal({{ form_num }}, 1)"
                                                        class="p-3 border border-gray-300 rounded text-sm focus:outline-none focus:border-blue-600 transition-colors">
                                                </div>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                                <div class="flex flex-col">
                                                    <label class="font-bold text-gray-800 mb-2 text-sm">Unit Price</label>
                                                    <input type="number" name="item_price_{{ form_num }}_1" min="0"
                                                        step="0.01" placeholder="0.00"
                                                        oninput="calculateItemTotal({{ form_num }}, 1)"
                                                        class="p-3 border border-gray-300 rounded text-sm focus:outline-none focus:border-blue-600 transition-colors">
                                                </div>
                                                <div class="flex flex-col">
                                                    <label class="font-bold text-gray-800 mb-2 text-sm">Total</label>
                                                    <input type="number" name="item_total_{{ form_num }}_1" readonly
                                                        placeholder="0.00" 
                                                        class="p-3 border border-gray-300 rounded text-sm bg-gray-100 font-bold text-gray-700">
                                                </div>
                                                <div class="flex flex-col">
                                                    <button type="button" class="bg-red-600 text-white py-3 px-4 border-none rounded text-sm cursor-pointer transition-colors duration-300 whitespace-nowrap hover:bg-red-700"
                                                        onclick="removeItem(this, {{ form_num }})"
                                                        style="display: none;">Remove Item</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-5">
                                        <button type="button" class="bg-gray-600 text-white py-3 px-6 border-none rounded text-base cursor-pointer transition-colors duration-300 w-full hover:bg-gray-700"
                                            onclick="addItem({{ form_num }})">Add Another Item</button>
                                    </div>
                                </div>

                                <div class="mt-8 p-5 bg-blue-50 border border-blue-200 rounded">
                                    <h4 class="text-gray-800 mb-5 text-lg font-semibold text-center">Financial Summary</h4>

                                    <!-- CAD Financial Breakdown -->
                                    <div class="bg-white p-5 rounded border border-gray-300 mb-5 cad-breakdown-{{ form_num }}">
                                        <div class="mb-4">
                                            <div class="mb-5">
                                                <label for="subtotal_amount_{{ form_num }}" class="block mb-2 font-bold text-gray-800">Subtotal (<span
                                                        class="currency-label-{{ form_num }}">CAD</span>)</label>
                                                <input type="number" id="subtotal_amount_{{ form_num }}"
                                                    name="subtotal_amount_{{ form_num }}" readonly min="0" step="0.01"
                                                    placeholder="0.00" class="w-full p-3 border border-gray-300 rounded box-border text-base bg-gray-100 font-bold text-gray-700">
                                                <small class="block text-xs text-gray-600 mt-1 italic">Automatically calculated from item totals
                                                    above</small>
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <div class="mb-5">
                                                <label for="discount_amount_{{ form_num }}" class="block mb-2 font-bold text-gray-800">Discount (<span
                                                        class="currency-label-{{ form_num }}">CAD</span>)</label>
                                                <input type="number" id="discount_amount_{{ form_num }}"
                                                    name="discount_amount_{{ form_num }}" min="0" step="0.01"
                                                    placeholder="0.00" oninput="calculateFinalTotal({{ form_num }})"
                                                    class="w-full p-3 border border-gray-300 rounded box-border text-base transition-all duration-300 focus:outline-none focus:border-blue-600">
                                                <small class="block text-xs text-gray-600 mt-1 italic">Coupons, promotional discounts, or
                                                    rebates</small>
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <div class="mb-5">
                                                <label for="hst_gst_amount_{{ form_num }}" class="block mb-2 font-bold text-gray-800"><span
                                                        class="tax-label-{{ form_num }}">HST/GST</span> (<span
                                                        class="currency-label-{{ form_num }}">CAD</span>) <span
                                                        class="required-indicator-{{ form_num }}"></span></label>
                                                <input type="number" id="hst_gst_amount_{{ form_num }}"
                                                    name="hst_gst_amount_{{ form_num }}" min="0" step="0.01"
                                                    placeholder="0.00" oninput="calculateFinalTotal({{ form_num }})"
                                                    class="w-full p-3 border border-gray-300 rounded box-border text-base transition-all duration-300 focus:outline-none focus:border-blue-600">
                                                <small class="block text-xs text-gray-600 mt-1 italic tax-help-{{ form_num }}">Harmonized Sales
                                                    Tax / Goods and Services Tax</small>
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <div class="mb-5">
                                                <label for="shipping_amount_{{ form_num }}" class="block mb-2 font-bold text-gray-800">Shipping & Handling (<span
                                                        class="currency-label-{{ form_num }}">CAD</span>)</label>
                                                <input type="number" id="shipping_amount_{{ form_num }}"
                                                    name="shipping_amount_{{ form_num }}" min="0" step="0.01"
                                                    placeholder="0.00" oninput="calculateFinalTotal({{ form_num }})"
                                                    class="w-full p-3 border border-gray-300 rounded box-border text-base transition-all duration-300 focus:outline-none focus:border-blue-600">
                                                <small class="block text-xs text-gray-600 mt-1 italic">Shipping, delivery, and handling
                                                    fees</small>
                                            </div>
                                        </div>

                                        <div class="border-t-2 border-blue-600 pt-4 mt-5">
                                            <div class="mb-5">
                                                <label for="total_amount_{{ form_num }}" class="block mb-2 font-bold text-gray-800">Total Reimbursement Amount
                                                    (<span class="currency-label-{{ form_num }}">CAD</span>)</label>
                                                <input type="number" id="total_amount_{{ form_num }}"
                                                    name="total_amount_{{ form_num }}" readonly min="0" step="0.01"
                                                    placeholder="0.00" class="w-full p-3 border-2 border-blue-600 rounded box-border text-lg font-bold bg-gray-100 text-gray-700">
                                                <small class="block text-xs text-gray-600 mt-1 italic">Automatically calculated (Subtotal -
                                                    Discount + Tax + Shipping)</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- USD Financial Breakdown -->
                                    <div class="financial-breakdown usd-breakdown-{{ form_num }}"
                                        style="display: none;">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="us_total_{{ form_num }}">US Subtotal (USD)</label>
                                                <input type="number" id="us_total_{{ form_num }}"
                                                    name="us_total_{{ form_num }}" min="0" step="0.01"
                                                    placeholder="0.00">
                                                <small class="financial-help">Subtotal in US dollars</small>
                                            </div>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="usd_taxes_{{ form_num }}">Taxes (USD)</label>
                                                <input type="number" id="usd_taxes_{{ form_num }}"
                                                    name="usd_taxes_{{ form_num }}" min="0" step="0.01"
                                                    placeholder="0.00">
                                                <small class="financial-help">Sales tax, state tax, or other applicable
                                                    taxes</small>
                                            </div>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="canadian_amount_{{ form_num }}">Canadian Amount
                                                    (CAD)</label>
                                                <input type="number" id="canadian_amount_{{ form_num }}"
                                                    name="canadian_amount_{{ form_num }}" min="0" step="0.01"
                                                    placeholder="0.00">
                                                <small class="financial-help">Equivalent amount in Canadian dollars for
                                                    reimbursement</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="mt-8 text-center">
                <div class="mb-5">
                    <button type="submit" id="submit-all-btn" class="bg-blue-600 text-white py-4 px-8 border-none rounded text-lg font-bold cursor-pointer w-full transition-colors duration-300 hover:bg-blue-700">Submit All Purchase Requests</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        // Track item counts for each form
        const itemCounts = {};
        const maxItems = 15;
        let isSubmitting = false;

        // Initialize item counts
        for (let i = 1; i <= 10; i++) {
            itemCounts[i] = 1;
        }

        function toggleForm(formNumber) {
            const content = document.getElementById(`form-${formNumber}`);
            const toggle = content.previousElementSibling.querySelector('.form-toggle');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                toggle.textContent = '▲';
            } else {
                content.style.display = 'none';
                toggle.textContent = '▼';
            }
        }

        function addItem(formNumber) {
            if (itemCounts[formNumber] >= maxItems) {
                alert(`Maximum of ${maxItems} items allowed per form.`);
                return;
            }

            itemCounts[formNumber]++;
            const container = document.getElementById(`items-container-${formNumber}`);
            const newRow = document.createElement('div');
            newRow.className = 'mb-4 p-4 bg-gray-50 rounded border border-gray-200';
            newRow.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <div class="flex flex-col">
                        <label class="font-bold text-gray-800 mb-2 text-sm">Item Name</label>
                        <input type="text" name="item_name_${formNumber}_${itemCounts[formNumber]}" placeholder="Enter item name" class="p-3 border border-gray-300 rounded text-sm focus:outline-none focus:border-blue-600 transition-colors">
                    </div>
                    <div class="flex flex-col">
                        <label class="font-bold text-gray-800 mb-2 text-sm">Usage/Purpose</label>
                        <input type="text" name="item_usage_${formNumber}_${itemCounts[formNumber]}" placeholder="What is this item for?" class="p-3 border border-gray-300 rounded text-sm focus:outline-none focus:border-blue-600 transition-colors">
                    </div>
                    <div class="flex flex-col">
                        <label class="font-bold text-gray-800 mb-2 text-sm">Quantity</label>
                        <input type="number" name="item_quantity_${formNumber}_${itemCounts[formNumber]}" min="1" value="1" oninput="calculateItemTotal(${formNumber}, ${itemCounts[formNumber]})" class="p-3 border border-gray-300 rounded text-sm focus:outline-none focus:border-blue-600 transition-colors">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="flex flex-col">
                        <label class="font-bold text-gray-800 mb-2 text-sm">Unit Price</label>
                        <input type="number" name="item_price_${formNumber}_${itemCounts[formNumber]}" min="0" step="0.01" placeholder="0.00" oninput="calculateItemTotal(${formNumber}, ${itemCounts[formNumber]})" class="p-3 border border-gray-300 rounded text-sm focus:outline-none focus:border-blue-600 transition-colors">
                    </div>
                    <div class="flex flex-col">
                        <label class="font-bold text-gray-800 mb-2 text-sm">Total</label>
                        <input type="number" name="item_total_${formNumber}_${itemCounts[formNumber]}" readonly placeholder="0.00" class="p-3 border border-gray-300 rounded text-sm bg-gray-100 font-bold text-gray-700">
                    </div>
                    <div class="flex flex-col">
                        <button type="button" class="bg-red-600 text-white py-3 px-4 border-none rounded text-sm cursor-pointer transition-colors duration-300 whitespace-nowrap hover:bg-red-700" onclick="removeItem(this, ${formNumber})">Remove Item</button>
                    </div>
                </div>
            `;
            container.appendChild(newRow);
            updateRemoveButtons(formNumber);
        }

        function removeItem(button, formNumber) {
            const row = button.closest('.mb-4.p-4.bg-gray-50.rounded.border.border-gray-200');
            row.remove();
            itemCounts[formNumber]--;
            updateRemoveButtons(formNumber);
            calculateSubtotal(formNumber);
        }

        function updateRemoveButtons(formNumber) {
            const container = document.getElementById(`items-container-${formNumber}`);
            const removeButtons = container.querySelectorAll('button[onclick*="removeItem"]');
            removeButtons.forEach(btn => {
                btn.style.display = itemCounts[formNumber] > 1 ? 'block' : 'none';
            });
        }

        function calculateItemTotal(formNumber, itemNumber) {
            const quantityInput = document.querySelector(`input[name="item_quantity_${formNumber}_${itemNumber}"]`);
            const priceInput = document.querySelector(`input[name="item_price_${formNumber}_${itemNumber}"]`);
            const totalInput = document.querySelector(`input[name="item_total_${formNumber}_${itemNumber}"]`);
            
            if (quantityInput && priceInput && totalInput) {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const total = quantity * price;
                
                totalInput.value = total.toFixed(2);
                calculateSubtotal(formNumber);
            }
        }

        function calculateSubtotal(formNumber) {
            const container = document.getElementById(`items-container-${formNumber}`);
            const totalInputs = container.querySelectorAll('input[name^="item_total_"]');
            let subtotal = 0;
            
            totalInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                subtotal += value;
            });
            
            // Always update the subtotal field (even if hidden for USD)
            const subtotalField = document.getElementById(`subtotal_amount_${formNumber}`);
            if (subtotalField) {
                subtotalField.value = subtotal.toFixed(2);
            }
            
            updateHstRequirement(formNumber, subtotal);
            calculateFinalTotal(formNumber);
        }

        function updateHstRequirement(formNumber, subtotal) {
            const currencySelect = document.getElementById(`currency_${formNumber}`);
            const hstGstInput = document.getElementById(`hst_gst_amount_${formNumber}`);
            const requiredIndicator = document.querySelector(`.required-indicator-${formNumber}`);
            const taxHelp = document.querySelector(`.tax-help-${formNumber}`);
            
            if (!currencySelect || !hstGstInput) return;
            
            const isCAD = currencySelect.value === 'CAD';
            const hasSubtotal = subtotal > 0;
            const shouldBeRequired = isCAD && hasSubtotal;
            
            if (shouldBeRequired) {
                hstGstInput.setAttribute('required', 'required');
                if (requiredIndicator) requiredIndicator.textContent = '*';
                if (taxHelp) taxHelp.textContent = 'Harmonized Sales Tax / Goods and Services Tax (required when items are added)';
            } else {
                hstGstInput.removeAttribute('required');
                if (requiredIndicator) requiredIndicator.textContent = '';
                if (taxHelp) taxHelp.textContent = 'Harmonized Sales Tax / Goods and Services Tax';
            }
        }

        function calculateFinalTotal(formNumber) {
            const subtotal = parseFloat(document.getElementById(`subtotal_amount_${formNumber}`).value) || 0;
            const discount = parseFloat(document.getElementById(`discount_amount_${formNumber}`).value) || 0;
            const hstGst = parseFloat(document.getElementById(`hst_gst_amount_${formNumber}`).value) || 0;
            const shipping = parseFloat(document.getElementById(`shipping_amount_${formNumber}`).value) || 0;
            
            const total = subtotal - discount + hstGst + shipping;
            document.getElementById(`total_amount_${formNumber}`).value = Math.max(0, total).toFixed(2);
        }

        function updateCurrencyLabels(formNumber) {
            const currencySelect = document.getElementById(`currency_${formNumber}`);
            const selectedCurrency = currencySelect.value;
            const currencyLabels = document.querySelectorAll(`.currency-label-${formNumber}`);
            const taxLabels = document.querySelectorAll(`.tax-label-${formNumber}`);
            const taxHelp = document.querySelector(`.tax-help-${formNumber}`);
            const proofOfPaymentSection = document.querySelector(`.proof-of-payment-section-${formNumber}`);
            const cadBreakdown = document.querySelector(`.cad-breakdown-${formNumber}`);
            const usdBreakdown = document.querySelector(`.usd-breakdown-${formNumber}`);
            const hstGstInput = document.getElementById(`hst_gst_amount_${formNumber}`);
            const hstGstLabel = document.querySelector(`label[for="hst_gst_amount_${formNumber}"]`);
            
            currencyLabels.forEach(label => {
                label.textContent = selectedCurrency;
            });
            
            // Update tax labels and requirements based on currency
            if (selectedCurrency === 'USD') {
                taxLabels.forEach(label => {
                    label.textContent = 'Taxes';
                });
                if (taxHelp) {
                    taxHelp.textContent = 'Sales tax, state tax, or other applicable taxes';
                }
                if (hstGstInput) {
                    hstGstInput.removeAttribute('required');
                }
                if (hstGstLabel) {
                    hstGstLabel.innerHTML = `<span class="tax-label-${formNumber}">Taxes</span> (<span class="currency-label-${formNumber}">USD</span>)`;
                }
                
                // Show USD breakdown, hide CAD breakdown
                if (cadBreakdown) cadBreakdown.style.display = 'none';
                if (usdBreakdown) usdBreakdown.style.display = 'block';
                
            } else {
                taxLabels.forEach(label => {
                    label.textContent = 'HST/GST';
                });
                if (hstGstLabel) {
                    hstGstLabel.innerHTML = `<span class="tax-label-${formNumber}">HST/GST</span> (<span class="currency-label-${formNumber}">CAD</span>) <span class="required-indicator-${formNumber}"></span>`;
                }
                
                // Update HST requirement based on current subtotal
                const subtotalInput = document.getElementById(`subtotal_amount_${formNumber}`);
                const currentSubtotal = parseFloat(subtotalInput ? subtotalInput.value : 0) || 0;
                updateHstRequirement(formNumber, currentSubtotal);
                
                // Show CAD breakdown, hide USD breakdown
                if (cadBreakdown) cadBreakdown.style.display = 'block';
                if (usdBreakdown) usdBreakdown.style.display = 'none';
            }
            
            // Show/hide proof of payment section based on currency
            if (selectedCurrency === 'USD') {
                proofOfPaymentSection.style.display = 'block';
                // Make proof of payment required for USD
                const proofOfPaymentInput = document.getElementById(`proof_of_payment_${formNumber}`);
                if (proofOfPaymentInput) {
                    proofOfPaymentInput.required = true;
                }
            } else {
                proofOfPaymentSection.style.display = 'none';
                // Remove required attribute for non-USD currencies
                const proofOfPaymentInput = document.getElementById(`proof_of_payment_${formNumber}`);
                if (proofOfPaymentInput) {
                    proofOfPaymentInput.required = false;
                    proofOfPaymentInput.value = ''; // Clear the field
                    // Reset filename display
                    const filenameSpan = document.getElementById(`payment-filename-${formNumber}`);
                    if (filenameSpan) {
                        filenameSpan.textContent = 'No file chosen';
                    }
                }
            }
        }

        function updateFileName(input, spanId) {
            const filenameSpan = document.getElementById(spanId);
            if (input.files && input.files[0]) {
                filenameSpan.textContent = input.files[0].name;
            } else {
                filenameSpan.textContent = 'No file chosen';
            }
        }

        function validateSubmission() {
            let hasValidForm = false;
            const errors = [];

            // Check each form for completeness
            for (let formNumber = 1; formNumber <= 10; formNumber++) {
                const vendorName = document.getElementById(`vendor_name_${formNumber}`);
                const invoiceFile = document.getElementById(`invoice_file_${formNumber}`);
                const currencySelect = document.getElementById(`currency_${formNumber}`);
                const proofOfPaymentFile = document.getElementById(`proof_of_payment_${formNumber}`);

                // Skip if vendor name is not filled
                if (!vendorName || !vendorName.value.trim()) {
                    continue;
                }

                // Check if invoice file is uploaded
                if (!invoiceFile || !invoiceFile.files || invoiceFile.files.length === 0) {
                    alert('Please upload an invoice file to Invoice #' + formNumber + ' before submitting.');
                    return false;
                }

                // For USD currency, check if proof of payment is uploaded
                if (currencySelect && currencySelect.value === 'USD') {
                    if (!proofOfPaymentFile || !proofOfPaymentFile.files || proofOfPaymentFile.files.length === 0) {
                        alert('Please upload a proof of payment file to Invoice #' + formNumber + ' before submitting.');
                        return false;
                    }
                }

                // Check if at least one item is properly filled
                let hasValidItem = false;
                const itemsContainer = document.getElementById(`items-container-${formNumber}`);
                if (itemsContainer) {
                    const itemRows = itemsContainer.querySelectorAll('.item-row');
                    
                    for (let row of itemRows) {
                        const nameInput = row.querySelector('input[name*="_name_"]');
                        const usageInput = row.querySelector('input[name*="_usage_"]');
                        const quantityInput = row.querySelector('input[name*="_quantity_"]');
                        const priceInput = row.querySelector('input[name*="_price_"]');

                        if (nameInput && nameInput.value.trim() && 
                            usageInput && usageInput.value.trim() && 
                            quantityInput && quantityInput.value && parseFloat(quantityInput.value) > 0 &&
                            priceInput && priceInput.value && parseFloat(priceInput.value) > 0) {
                            hasValidItem = true;
                            break;
                        }
                    }
                }

                // If this form has vendor, invoice, and at least one valid item, it's complete
                if (hasValidItem) {
                    hasValidForm = true;
                }
            }

            if (!hasValidForm) {
                alert('Please complete at least one invoice form before submitting.\n\nTo complete a form, you need:\n• Vendor/Store Name\n• Invoice file uploaded\n• At least one item with name, usage, quantity, and price\n• Proof of payment (for USD purchases only)');
                return false;
            }

            // Check that total Canadian price is greater than $100 for each completed form
            let totalCanadianAmount = 0;
            for (let formNumber = 1; formNumber <= 10; formNumber++) {
                const vendorName = document.getElementById(`vendor_name_${formNumber}`);
                const currencySelect = document.getElementById(`currency_${formNumber}`);
                
                // Skip if vendor name is not filled (form not in use)
                if (!vendorName || !vendorName.value.trim()) {
                    continue;
                }

                
                if (currencySelect && currencySelect.value === 'CAD') {
                    // For CAD forms, use the total_amount field
                    const totalAmountField = document.getElementById(`total_amount_${formNumber}`);
                    if (totalAmountField && totalAmountField.value) {
                        totalCanadianAmount += parseFloat(totalAmountField.value) || 0;
                    }
                } else if (currencySelect && currencySelect.value === 'USD') {
                    // For USD forms, use the canadian_amount field
                    const canadianAmountField = document.getElementById(`canadian_amount_${formNumber}`);
                    if (canadianAmountField && canadianAmountField.value) {
                        totalCanadianAmount += parseFloat(canadianAmountField.value) || 0;
                    }
                }
                
            }
            if (totalCanadianAmount < 100) {
                alert(`Total Canadian amount must be greater than $100.00 CAD.\nCurrent total: $${totalCanadianAmount.toFixed(2)} CAD`);
                return false;
            }

            return true;
        }

        function clearForm(formNumber) {
            if (!confirm(`Are you sure you want to clear all data in Purchase Request #${formNumber}? This action cannot be undone.`)) {
                return;
            }

            // Clear basic form fields
            const vendorNameInput = document.getElementById(`vendor_name_${formNumber}`);
            if (vendorNameInput) vendorNameInput.value = '';

            // Reset currency to CAD (default)
            const currencySelect = document.getElementById(`currency_${formNumber}`);
            if (currencySelect) {
                currencySelect.value = 'CAD';
                updateCurrencyLabels(formNumber); // This will update visibility and labels
            }

            // Clear file inputs and reset filename displays
            const invoiceFileInput = document.getElementById(`invoice_file_${formNumber}`);
            const proofOfPaymentInput = document.getElementById(`proof_of_payment_${formNumber}`);
            const invoiceFilenameSpan = document.getElementById(`invoice-filename-${formNumber}`);
            const paymentFilenameSpan = document.getElementById(`payment-filename-${formNumber}`);

            if (invoiceFileInput) {
                invoiceFileInput.value = '';
                invoiceFileInput.files = null;
            }
            if (proofOfPaymentInput) {
                proofOfPaymentInput.value = '';
                proofOfPaymentInput.files = null;
            }
            if (invoiceFilenameSpan) invoiceFilenameSpan.textContent = 'No file chosen';
            if (paymentFilenameSpan) paymentFilenameSpan.textContent = 'No file chosen';

            // Clear all items except the first one
            const itemsContainer = document.getElementById(`items-container-${formNumber}`);
            if (itemsContainer) {
                // Remove all item rows except the first one (using the new Tailwind class selector)
                const itemRows = itemsContainer.children;
                for (let i = itemRows.length - 1; i >= 1; i--) {
                    itemRows[i].remove();
                }

                // Clear the first item row
                const firstRow = itemRows[0];
                if (firstRow) {
                    const inputs = firstRow.querySelectorAll('input');
                    inputs.forEach(input => {
                        if (input.name.includes('_quantity_')) {
                            input.value = '1'; // Reset quantity to 1
                        } else {
                            input.value = '';
                        }
                    });
                }

                // Reset item count for this form
                itemCounts[formNumber] = 1;
                updateRemoveButtons(formNumber);
            }

            // Clear financial breakdown fields for CAD
            const cadFinancialFields = [
                `subtotal_amount_${formNumber}`,
                `discount_amount_${formNumber}`,
                `hst_gst_amount_${formNumber}`,
                `shipping_amount_${formNumber}`,
                `total_amount_${formNumber}`
            ];

            cadFinancialFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.value = '';
            });

            // Clear financial breakdown fields for USD
            const usdFinancialFields = [
                `us_total_${formNumber}`,
                `usd_taxes_${formNumber}`,
                `canadian_amount_${formNumber}`
            ];

            usdFinancialFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.value = '';
            });

            // Remove any required attributes and indicators that might have been set
            const hstGstInput = document.getElementById(`hst_gst_amount_${formNumber}`);
            const requiredIndicator = document.querySelector(`.required-indicator-${formNumber}`);
            if (hstGstInput) hstGstInput.removeAttribute('required');
            if (requiredIndicator) requiredIndicator.textContent = '';

            console.log(`Form ${formNumber} has been cleared successfully.`);
        }

        // Initialize the dashboard when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all forms
            for (let i = 1; i <= 10; i++) {
                const content = document.getElementById(`form-${i}`);
                content.style.display = 'none';

                // Initialize currency labels
                updateCurrencyLabels(i);

                // Initialize proof of payment section visibility
                const proofOfPaymentSection = document.getElementById(`proof_of_payment_${i}`);
                if (proofOfPaymentSection) {
                    const currencySelect = document.getElementById(`currency_${i}`);
                    if (currencySelect && currencySelect.value === 'USD') {
                        proofOfPaymentSection.style.display = 'block';
                    } else {
                        proofOfPaymentSection.style.display = 'none';
                    }
                }
            }

            // Set up form submission handling with double-submit prevention
            const form = document.querySelector('form[action="/submit-all-requests"]');
            const submitBtn = document.getElementById("submit-all-btn");

            form.addEventListener("submit", (e) => {
                if (isSubmitting) {
                    // already in flight, block
                    e.preventDefault();
                    return;
                }

                if (!validateSubmission()) {
                    // validation failed, do not proceed
                    e.preventDefault();
                    return;
                }

                // mark as submitting and disable button
                isSubmitting = true;
                submitBtn.disabled = true;
                submitBtn.textContent = "Submitting… (This may take a few minutes)";

                // If you want to guard against the user navigating away and then coming back
                // you could also set a short timeout to re-enable in case of unexpected failure:
                setTimeout(() => {
                    // safety net: if submission didn't go through after, say, 30s, re-enable
                    if (isSubmitting) {
                        isSubmitting = false;
                        submitBtn.disabled = false;
                        submitBtn.textContent = "Submit All Purchase Requests";
                    }
                }, 45000);
            });
        });
    </script>
</body>

</html>