<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Purchase Request #{{ form_number }}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/styles.css') }}">
</head>
<body>
    <div class="container">
        <h1>Purchase Request #{{ form_number }} - Step 2</h1>
        <p class="subtitle">Enter the reimbursement details for your purchase request</p>
        
        <div class="form-section">
            <h2>Reimbursement Information</h2>
            
            <div class="info-summary">
                <p><strong>Form:</strong> Purchase Request #{{ form_number }}</p>
                <p><strong>Name:</strong> {{ name }}</p>
                <p><strong>Team:</strong> {{ team }}</p>
                <p><strong>McMaster Email:</strong> {{ email }}</p>
            </div>
            
            <form method="POST" action="/submit-final-request/{{ form_number }}" enctype="multipart/form-data">
                <!-- Hidden fields to carry forward the data from step 1 -->
                <input type="hidden" name="form_number" value="{{ form_number }}">
                <input type="hidden" name="name" value="{{ name }}">
                <input type="hidden" name="email" value="{{ email }}">
                <input type="hidden" name="e_transfer_email" value="{{ e_transfer_email }}">
                <input type="hidden" name="address" value="{{ address }}">
                <input type="hidden" name="team" value="{{ team }}">
                
                <div class="form-group">
                    <label for="vendor_name">Vendor/Store Name *</label>
                    <input type="text" id="vendor_name" name="vendor_name" required placeholder="Enter the name of the vendor or store">
                </div>
                
                <div class="form-group">
                    <label for="invoice_file">Upload Invoice/Receipt *</label>
                    <input type="file" id="invoice_file" name="invoice_file" required accept=".pdf,.jpg,.jpeg,.png,.gif">
                    <small class="file-help">Please upload your invoice or receipt (PDF, JPG, PNG, or GIF format)</small>
                </div>
                
                <div class="items-section">
                    <h3>Item Details</h3>
                    <small class="items-help">Add the items you purchased (up to 15 items)</small>
                    
                    <div id="items-container">
                        <div class="item-row">
                            <div class="item-input-group">
                                <label>Item Name *</label>
                                <input type="text" name="item_name_1" required placeholder="Enter item name">
                            </div>
                            <div class="item-input-group">
                                <label>Usage/Purpose *</label>
                                <input type="text" name="item_usage_1" required placeholder="What is this item for?">
                            </div>
                            <div class="item-input-group">
                                <label>Quantity *</label>
                                <input type="number" name="item_quantity_1" required min="1" value="1" onchange="calculateItemTotal(1)">
                            </div>
                            <div class="item-input-group">
                                <label>Unit Price (CAD) *</label>
                                <input type="number" name="item_price_1" required min="0" step="0.01" placeholder="0.00" onchange="calculateItemTotal(1)">
                            </div>
                            <div class="item-input-group">
                                <label>Total (CAD)</label>
                                <input type="number" name="item_total_1" readonly placeholder="0.00" class="total-field">
                            </div>
                            <div class="item-actions">
                                <button type="button" class="btn-remove" onclick="removeItem(this)" style="display: none;">Remove</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" id="add-item-btn" class="btn-secondary" onclick="addItem()">Add Another Item</button>
                    </div>
                </div>
                
                <div class="total-section">
                    <h3>Financial Summary</h3>
                    
                    <div class="financial-breakdown">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="subtotal_amount">Subtotal (CAD)</label>
                                <input type="number" id="subtotal_amount" name="subtotal_amount" readonly min="0" step="0.01" placeholder="0.00" class="total-field">
                                <small class="financial-help">Automatically calculated from item totals above</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="discount_amount">Discount (CAD)</label>
                                <input type="number" id="discount_amount" name="discount_amount" min="0" step="0.01" placeholder="0.00" onchange="calculateFinalTotal()">
                                <small class="financial-help">Coupons, promotional discounts, or rebates</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hst_gst_amount">HST/GST (CAD)</label>
                                <input type="number" id="hst_gst_amount" name="hst_gst_amount" min="0" step="0.01" placeholder="0.00" onchange="calculateFinalTotal()">
                                <small class="financial-help">Harmonized Sales Tax / Goods and Services Tax</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="shipping_amount">Shipping & Handling (CAD)</label>
                                <input type="number" id="shipping_amount" name="shipping_amount" min="0" step="0.01" placeholder="0.00" onchange="calculateFinalTotal()">
                                <small class="financial-help">Shipping, delivery, and handling fees</small>
                            </div>
                        </div>
                        
                        <div class="form-row total-row">
                            <div class="form-group">
                                <label for="total_amount">Total Reimbursement Amount (CAD) *</label>
                                <input type="number" id="total_amount" name="total_amount" required min="0" step="0.01" placeholder="0.00" readonly class="total-field">
                                <small class="financial-help">Automatically calculated (Subtotal - Discount + Tax + Shipping)</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="calculation-buttons">
                        <button type="button" class="btn-calc" onclick="calculateFinalTotal()">Recalculate Total</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn">Submit Purchase Request #{{ form_number }}</button>
                </div>
                
                <div class="form-group">
                    <a href="/dashboard?name={{ name }}&email={{ email }}&e_transfer_email={{ e_transfer_email }}&address={{ address }}&team={{ team }}" class="btn-secondary">Back to Dashboard</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        let itemCount = 1;
        const maxItems = 15;

        function addItem() {
            if (itemCount >= maxItems) {
                alert(`Maximum of ${maxItems} items allowed.`);
                return;
            }

            itemCount++;
            const container = document.getElementById('items-container');
            const newRow = document.createElement('div');
            newRow.className = 'item-row';
            newRow.innerHTML = `
                <div class="item-input-group">
                    <label>Item Name *</label>
                    <input type="text" name="item_name_${itemCount}" required placeholder="Enter item name">
                </div>
                <div class="item-input-group">
                    <label>Usage/Purpose *</label>
                    <input type="text" name="item_usage_${itemCount}" required placeholder="What is this item for?">
                </div>
                <div class="item-input-group">
                    <label>Quantity *</label>
                    <input type="number" name="item_quantity_${itemCount}" required min="1" value="1" onchange="calculateItemTotal(${itemCount})">
                </div>
                <div class="item-input-group">
                    <label>Unit Price (CAD) *</label>
                    <input type="number" name="item_price_${itemCount}" required min="0" step="0.01" placeholder="0.00" onchange="calculateItemTotal(${itemCount})">
                </div>
                <div class="item-input-group">
                    <label>Total (CAD)</label>
                    <input type="number" name="item_total_${itemCount}" readonly placeholder="0.00" class="total-field">
                </div>
                <div class="item-actions">
                    <button type="button" class="btn-remove" onclick="removeItem(this)">Remove</button>
                </div>
            `;
            container.appendChild(newRow);
            
            // Show remove buttons for all items when there's more than one
            updateRemoveButtons();
            
            // Update the add button state
            if (itemCount >= maxItems) {
                document.getElementById('add-item-btn').style.display = 'none';
            }
        }

        function removeItem(button) {
            const row = button.closest('.item-row');
            row.remove();
            itemCount--;
            
            // Show add button if we're under the limit
            if (itemCount < maxItems) {
                document.getElementById('add-item-btn').style.display = 'block';
            }
            
            updateRemoveButtons();
            calculateSubtotal(); // Recalculate subtotal when item is removed
        }

        function updateRemoveButtons() {
            const removeButtons = document.querySelectorAll('.btn-remove');
            removeButtons.forEach(btn => {
                btn.style.display = itemCount > 1 ? 'block' : 'none';
            });
        }

        function calculateItemTotal(itemNumber) {
            const quantityInput = document.querySelector(`input[name="item_quantity_${itemNumber}"]`);
            const priceInput = document.querySelector(`input[name="item_price_${itemNumber}"]`);
            const totalInput = document.querySelector(`input[name="item_total_${itemNumber}"]`);
            
            if (quantityInput && priceInput && totalInput) {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const total = quantity * price;
                
                totalInput.value = total.toFixed(2);
                calculateSubtotal(); // Automatically update subtotal when item total changes
            }
        }

        function calculateSubtotal() {
            const totalInputs = document.querySelectorAll('input[name^="item_total_"]');
            let subtotal = 0;
            
            totalInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                subtotal += value;
            });
            
            document.getElementById('subtotal_amount').value = subtotal.toFixed(2);
            calculateFinalTotal(); // Update final total when subtotal changes
        }

        function calculateFinalTotal() {
            const subtotal = parseFloat(document.getElementById('subtotal_amount').value) || 0;
            const discount = parseFloat(document.getElementById('discount_amount').value) || 0;
            const hstGst = parseFloat(document.getElementById('hst_gst_amount').value) || 0;
            const shipping = parseFloat(document.getElementById('shipping_amount').value) || 0;
            
            // Calculate: Subtotal - Discount + Tax + Shipping
            const total = subtotal - discount + hstGst + shipping;
            document.getElementById('total_amount').value = Math.max(0, total).toFixed(2); // Ensure non-negative
        }

        // Add event listeners to calculate totals when prices or quantities change
        document.addEventListener('change', function(e) {
            if (e.target.name && (e.target.name.startsWith('item_price_') || e.target.name.startsWith('item_quantity_'))) {
                const itemNumber = e.target.name.split('_').pop();
                calculateItemTotal(itemNumber);
            }
        });

        // Calculate initial totals
        calculateItemTotal(1);
    </script>
</body>
</html> 