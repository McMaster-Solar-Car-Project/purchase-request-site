name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
     - name: Deploy to server
       uses: appleboy/ssh-action@v1.0.3
       with:
         host: ${{ secrets.HOST }}
         username: ${{ secrets.USERNAME }}
         key: ${{ secrets.SSH_KEY }}
         command_timeout: 20m
         debug: true
         script: |
           cd /home/raj/purchase-request-site
           echo "Starting deployment for commit: ${{ github.sha }}"
           
           git fetch origin
           git reset --hard origin/main
           
           echo "Running uv sync..."
           uv sync --verbose > uv-sync.log 2>&1
           if [ $? -ne 0 ]; then
             echo "Error: uv sync failed. See uv-sync.log for details."
             cat uv-sync.log
             exit 1
           fi
           
           systemctl restart purchase-request
           systemctl is-active --quiet purchase-request
           if [ $? -eq 0 ]; then
             echo "Application restarted successfully"
           else
             echo "Error: Application failed to start"
             systemctl status purchase-request
             exit 1
           fi
           
           echo "Deployment completed successfully"