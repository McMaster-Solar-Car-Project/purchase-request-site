name: Deploy to Ubuntu Server

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.2.2
      with:
        host: 134.122.41.229
        username: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 10m
        script: |
          echo "🔗 Connection successful!"
          whoami
          pwd
          cd /root/Purchase_Request_Site
          
          echo "🔄 Deploying Purchase Request Site..."
          
          # Pull latest changes
          echo "📥 Pulling latest code..."
          git pull origin main
          
          # Install/update dependencies
          echo "📦 Installing dependencies..."
          uv sync
          
          # Restart systemd service
          echo "🔄 Restarting purchase-request-site service..."
          systemctl restart purchase-request-site
          
          # Wait for service to start
          echo "⏳ Waiting for service to start..."
          sleep 3
          
          # Check service status
          echo "🔍 Checking service status..."
          if systemctl is-active --quiet purchase-request-site; then
            echo "✅ Service is running successfully!"
            echo "📊 Service status:"
            systemctl status purchase-request-site --no-pager -l
          else
            echo "❌ Service failed to start!"
            echo "📄 Service logs:"
            journalctl -u purchase-request-site --no-pager -n 20
            exit 1
          fi
          
          # Health check HTTP endpoint
          echo "🌐 Testing HTTP endpoint..."
          sleep 2
          if curl -f http://localhost:8000 > /dev/null 2>&1; then
            echo "✅ HTTP endpoint is responding!"
          else
            echo "⚠️  HTTP endpoint not responding (might take a moment to start)"
          fi
          
          echo "🎉 Deployment completed successfully!" 