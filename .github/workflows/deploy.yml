name: Deploy to Ubuntu Server

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.2.2
      with:
        host: 134.122.41.229
        username: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 10m
        script: |
          echo "ğŸ”— Connection successful!"
          whoami
          pwd
          cd /root/Purchase_Request_Site
          
          echo "ğŸ”„ Deploying Purchase Request Site..."
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
          
          # Install/update dependencies
          echo "ğŸ“¦ Installing dependencies..."
          uv sync
          
          # Restart systemd service
          echo "ğŸ”„ Restarting purchase-request-site service..."
          systemctl restart purchase-request-site
          
          # Wait for service to start
          echo "â³ Waiting for service to start..."
          sleep 3
          
          # Check service status
          echo "ğŸ” Checking service status..."
          if systemctl is-active --quiet purchase-request-site; then
            echo "âœ… Service is running successfully!"
            echo "ğŸ“Š Service status:"
            systemctl status purchase-request-site --no-pager -l
          else
            echo "âŒ Service failed to start!"
            echo "ğŸ“„ Service logs:"
            journalctl -u purchase-request-site --no-pager -n 20
            exit 1
          fi
          
          # Health check HTTP endpoint
          echo "ğŸŒ Testing HTTP endpoint..."
          sleep 2
          if curl -f http://localhost:8000 > /dev/null 2>&1; then
            echo "âœ… HTTP endpoint is responding!"
          else
            echo "âš ï¸  HTTP endpoint not responding (might take a moment to start)"
          fi
          
          echo "ğŸ‰ Deployment completed successfully!" 